#!/bin/bash

# shellcheck disable=SC1090,1091

NL=$'\n'
TAB=$'\t'
# unicode justification markers
LRM=$'\u200E'  # LEFT-TO-RIGHT MARK
RLM=$'\u200F'  # RIGHT-TO-LEFT MARK
WARNING_ICON=$'\u26A0'
NO_BREAK_SPACE=$'\u00A0'
FULLWIDTH_LEFT_PARENTHESIS=$'\uFF08'
FULLWIDTH_RIGHT_PARENTHESIS=$'\uFF09'
DOUBLE_QUOTE=$'\u0022'

COLONS=(
    ':'        # COLON
    # potential colon substitutes
    $'\u003A'  # ASCII_COLON
    $'\uFF1A'  # FULL_WIDTH_COLON
    $'\uFE13'  # VERTICAL_COLON
    $'\uFE55'  # SMALL_COLON
    $'\u1361'  # ETHIOPIC_WORDSPACE
    $'\u0589'  # ARMENIAN_FULL_STOP
    $'\u05C3'  # HEBREW_SOF_PASUQ
    $'\uA789'  # MODIFIER_LETTER_COLON
    $'\u2236'  # RATIO_COLON
    $'\u205A'  # TWO_DOT_PUNCTUATION
)

STOPS=(
    '.'
    $'\u3002'  # IDEOGRAPHIC_FULL_STOP
    $'\u0964'  # DEVANAGARI_DANDA
    $'\u1362'  # ETHIOPIC_FULL_STOP
)


# default language
LANGUAGE="en"
LANGUAGE_DIRECTION="LTR"

trap "exit 1" TERM
export TOP_PID=$$

error_exit() {
    cmd_info="${TEXT_CMD_INFO//0/$2}: ${NL}${NL}$1${NL}${NL}"
    output_info="$TEXT_OUTPUT:${NL}${NL}$3"

    if zenity --text-info --title="$TITLE${NL}$WARNING_ICON $TEXT_ERROR" \
        --width=600 --height=500 \
        --cancel-label="${LRM}$ERROR_BTN_EXIT" \
        --ok-label="${LRM}$ERROR_BTN_RETRY" \
        2> /dev/null <<< "$cmd_info$output_info" ; then
        echo 1
    else
        kill -s TERM $TOP_PID
        echo 0
    fi
}

exec_command() {
    command="$1"
    status=1
    while (( status )); do
        output="$(eval "$command" 2>&1)"
        status=$?
        if (( status )); then
            >&2 echo "$output"
            status=$(error_exit "$command" "$status" "$output")
        else
            echo "$output"
        fi
    done
}

check_lang() {
    codes=$(trans --list-codes)
    for code in $codes ; do
        [[ "$code" == "$1" ]] && return
    done
    err_text="Invalid language code: $1"
    if ! zenity --question --title="$TITLE - Error" \
        --text="$err_text${NL}${NL}Do you wish to continue?" \
        --width=300 --icon="data-warning" --no-markup ; then
        kill -s TERM $TOP_PID
    fi
}

strip_prefixes() (
    colons=${COLONS[*]}
    colons=${colons// /}
    while read -r line; do
        [[ "$line" =~ (warning|mismatch|^$) ]] && continue
        line="${line#*[$colons]}"
        echo "${line##[ ${NO_BREAK_SPACE}]}"
    done <<< "$1"
)

translate() {
    cmd="trans -b -4 -no-warn -e \"$ENGINE\" -4 en:$lang \"$1\""
    trans_output="$(exec_command "$cmd")"
    stops=${STOPS[*]}
    stops=${stops// /}
    # double quotes noticed in hebrew output    
    trans_output="${trans_output//[${stops}${DOUBLE_QUOTE}]/}"
    trans_output="${trans_output//[(${FULLWIDTH_LEFT_PARENTHESIS}]/}"
    trans_output="${trans_output//[)${FULLWIDTH_RIGHT_PARENTHESIS}]/$'\n'}"
    echo "$trans_output"
}

translate_locations() {
    local -n locations=$1
    local lang=$2
    local output_file=$3
    local trans_input
    local trans_output
    local location

    for location in "${locations[@]}"; do
        trans_input+="(${location%:*}). "
    done

    trans_output=$(translate "$trans_input")
    echo "LOCATIONS_NATIVE=(" > "$output_file"
    while read -r line; do
        [[ "$line" == "" ]] && continue
        echo "${TAB}\"${line}\"" >> "$output_file"
    done < <(echo "$trans_output")
    echo ")" >> "$output_file"
}

translate_labels() {
    local -n labels=$1
    local -n label_ids=$2
    local lang=$3
    local output_file=$4
    local prefix=$5
    local trans_input
    local trans_output
    local translated_lines

    for label in "${labels[@]}"; do
        trans_input+="($prefix$label). "
    done

    trans_output=$(translate "$trans_input")
    if [[ -n "$prefix" ]]; then
        translated_lines="$(strip_prefixes "$trans_output")"
    else
        translated_lines="$trans_output"
    fi
    mapfile -t translations <<< "$translated_lines"

    for (( i=0; i < ${#label_ids[@]}; ++i )); do
        trans="${translations[i]}"
        [[ "$LANGUAGE_DIRECTION" == "LTR" ]] && trans="${trans^}"
        echo "${label_ids[i]}=\"${trans#"${trans%%[![:space:]]*}"}\"" \
            >> "$output_file"
    done
}

translate_codes() {
    local -n codes=$1
    local lang=$2
    local output_file=$3
    local prefix=$4
    local trans_input
    local trans_output
    local translated_lines
    local code
    local i=0

    # big chunks can break trans
    for (( i=0; i < "${#codes[@]}"; ++i )); do
        code="${codes[$i]}"
        [[ $code == "" ]] && code="*******"
        if (( i < 33 )) ; then
            trans_input1+="($prefix$code). "
        elif (( i < 66 )) ; then
            trans_input2+="($prefix$code). "
        else
            trans_input3+="($prefix$code). "
        fi
    done

    trans_output="$(translate "$trans_input1")${NL}"
    trans_output+="$(translate "$trans_input2")${NL}"
    trans_output+="$(translate "$trans_input3")"
    translated_lines="$(strip_prefixes "$trans_output")"
    echo "CONDITIONS_NATIVE=(" > "$output_file"
    while read -r line; do
        echo "${TAB}\"${line}\"" >> "$output_file"
    done < <(echo "$translated_lines")
    echo ")" >> "$output_file"
}

translate_extra_parameters() {
    local -n params=$1
    local lang=$2
    local output_file=$3
    local prefix=$4
    local trans_input
    local trans_output
    local translated_lines

    for p in "${params[@]}" ; do
        p="${p//_/ }"
        p="${p^}"
        trans_input+="($prefix$p). "
    done

    trans_output=$(translate "$trans_input")

    if [[ -n "$prefix" ]]; then
        translated_lines="$(strip_prefixes "$trans_output")"
    else
        translated_lines="$trans_output"
    fi

    local i=0
    while read -r line; do
        case "${params[i]}" in
            "cape" )
                k="CAPE"
                line=$k ;;
            "total_column_integrated_water_vapour" )
                k="TCWV"
                line=$k ;;
            *)
                typeset -u k="${params[i]}"
        esac
        [[ "$LANGUAGE_DIRECTION" == "LTR" ]] && line="${line^}"
        echo "$k=\"${line}\"" >> "$output_file"
        (( ++i ))
    done <<< "$translated_lines"
}

label_weather() {
    local weather

    while IFS=':' read -r parameter value ; do

        if [[ "$parameter$value" == "" ]] ; then
            weather+="${NL}"
            continue
        fi

        typeset -u param_uppercase="$parameter"
        label_id="${param_uppercase//[ ]/_}"
        label_value=${!label_id}

        if [ -n "${!label_id+x}" ] ; then
            # shellcheck disable=SC2199
            [[ "${EXCLUDED[@]}" =~ $label_value ]] && label_value="$parameter"
            if [[ "$LANGUAGE_DIRECTION" == "RTL" ]] ; then
                weather+="${RLM}$label_value: ${RLM}${LRM}$value${LRM}${NL}"
            else
                weather+="$label_value: $value${NL}"
            fi
        fi

    done <<< "$1"

    echo "$weather"
}

script_path="${0}"

while [ -L "${script_path}" ] ; do
    path="$(readlink "${script_path}")"
    [[ "${path}" == /* ]] && script_path="$path" || \
        script_path="$(dirname "${script_path}")/${path}"
done

script_dir="$(dirname "${script_path}")"

source "$script_dir/weather-now-menu.conf"
locations_file="$script_dir/locations"
locations_native_file="$script_dir/locations-native"
labels_native_file="$script_dir/labels-native"
conditions_native_file="$script_dir/conditions-native"
last_location_file="$script_dir/last-location"

[[ -e "$locations_file" ]] && source "${locations_file}"

if [[ -n "$1"  ]] ; then
    check_lang "$1"
    rm -f "$last_location_file"
    rm -f "$labels_native_file"
    rm -f "$conditions_native_file"
    LANGUAGE_DIRECTION="LTR"
    if [[ "$1" ==  "en" ]] ; then
        rm -f "$locations_native_file"
    else
        echo "LANGUAGE=\"$1\"" > "$labels_native_file"
        if trans -L "$1" | grep -q "R-to-L" ; then
            LANGUAGE_DIRECTION="RTL"
            echo 'LANGUAGE_DIRECTION="RTL"' >> "$labels_native_file"
        else
            echo 'LANGUAGE_DIRECTION="LTR"' >> "$labels_native_file"
        fi
        coproc progress_dlg { zenity --progress --pulsate \
            --no-cancel --auto-close \
            --title="$TITLE" \
            --text="Translating labels and locations..." ; }
        # translate_labels <labels> <label ids> <lang> <output file> [prefix]
        # where prefix is used to influence translate-shell results
        translate_locations LOCATIONS "$1" "$locations_native_file"
        translate_labels LABELS LABEL_IDS "$1" "$labels_native_file" "Command: "
        translate_labels PARAMETER_LABELS PARAMETER_IDS \
            "$1" "$labels_native_file" "Weather: "
        translate_codes CONDITIONS "$1" "$conditions_native_file" "Weather: "
        if [ -n "${EXTRA_PARAMS+x}" ] ; then 
            translate_extra_parameters EXTRA_PARAMS "$1" \
                "$labels_native_file" "Weather: "
        fi
        echo 100  >&"${progress_dlg[1]}"
    fi
fi

[[ -e "$locations_native_file" ]] && source "${locations_native_file}"
[[ -e "$labels_native_file" ]] && source "${labels_native_file}"
[[ -e "$conditions_native_file" ]] && source "${conditions_native_file}"

while true; do

    if [ -n "${last_location+x}" ] ; then
        unset location_data
        results=""
    fi
    if [[ -f "$last_location_file" ]]; then
        if [[ "$LANGUAGE" == "en" ]] ; then
            IFS=':' read -r placename country_code index \
                < <(cat "$last_location_file")
        else
            IFS=':' read -r placename_native placename country_code index \
                < <(cat "$last_location_file")
        fi
        # shellcheck disable=SC2153
        if [[ " ${LOCATIONS[*]} " =~ ${placename}:${country_code} ]]; then
            if [[ "$LANGUAGE" == en ]] ; then
                location_data+=( "$placename" "$country_code" "$index" )
            else
                location_data+=( "$placename_native" "$placename" \
                    "$country_code" "$index" )
            fi
        fi
    fi

    for (( i=0; i < ${#LOCATIONS[@]}; i++ )); do
        loc="${LOCATIONS[$i]}"
        [[ "$loc" == "$placename:$country_code" ]] && continue
        if [[ "$LANGUAGE" == en ]] ; then
            location_data+=( "${loc%:*}" "${loc#*:}" "$i" )
        else
            location_data+=( "${LOCATIONS_NATIVE[$i]}" \
                "${loc%:*}" "${loc#*:}" "$i" )
        fi
    done

    if [[ "$LANGUAGE_DIRECTION" == "RTL" ]] ; then
        width=600;height=600
    else
        width=500;height=400
    fi

    if [[ "$LANGUAGE" == "en" ]] ; then
        location=$(zenity --list \
            --title="$TITLE" \
            --text="$MENU_TEXT:" \
            --width="$width" \
            --height="$height" \
            --separator=":" \
            --column="$COLUMN_LOCATION" \
            --column="$COLUMN_COUNTRY_CODE" \
            --column="$COLUMN_INDEX" \
            --hide-column=3 \
            --print-column=ALL \
            --cancel-label="${LRM}$MENU_BTN_CANCEL" \
            --ok-label="${LRM}$MENU_BTN_OK" \
            "${location_data[@]}")
    else
        location=$(zenity --list \
            --title="$TITLE" \
            --text="$MENU_TEXT:" \
            --width="$width" \
            --height="$height" \
            --separator=":" \
            --column="$COLUMN_LOCATION_NATIVE" \
            --column="$COLUMN_LOCATION" \
            --column="$COLUMN_COUNTRY_CODE" \
            --column="$COLUMN_INDEX" \
            --hide-column=4 \
            --print-column=ALL \
            --cancel-label="${LRM}$MENU_BTN_CANCEL" \
            --ok-label="${LRM}$MENU_BTN_OK" \
            "${location_data[@]}")
    fi

    [[ -z "$location" ]] && exit 0

    if [[ "$LANGUAGE" == "en" ]] ; then
        IFS=':' read -r placename country_code index < <(echo "$location")
        place="$placename"
    else
        IFS=':' read -r placename_native placename country_code index \
            < <(echo "$location")
        place="$placename_native"
    fi

    if [[ "$CONFIG_NAME" == "simple" ]] ; then
        output_type="simple"
    else
        output_type="data-alt"
    fi

    params_extra="${EXTRA_PARAMS[*]}"
    params_extra=${params_extra// /${NL}}

    while read -r line; do
        k="${line%%:*}"
        v=${line#*: }
        case $k in
        "Conditions")
            code=${v%[*}
            s=${v#*[};description=${s%*]}
            if [[ "$LANGUAGE" == "en" ]] ; then
                results+="$k: $description${NL}"
            else
                results+="$k: ${CONDITIONS_NATIVE["$code"]}${NL}"
            fi ;;
        "Weather symbol" )
            symbol=$v ;;
        *)
            results+="$line${NL}" ;;
        esac
    done < <(exec_command "echo \"$params_extra\" | \"$script_dir/weather_now.py\" \
        -l \"$placename\" -c \"$country_code\" \
        -t \"$TEMPERATURE_UNIT\" -p \"$PRECIPITATION_UNIT\" \
        -w \"$WIND_SPEED_UNIT\" $WIND_IN_DEGREES -o \"data-alt\" -")

    if [[ "$LANGUAGE" == "en" ]] ; then
        weather="$results"
    else
        weather=$(label_weather "$(printf "%b" "$results")")
    fi

    if [[ "$output_type" == "simple" ]] ; then
        zenity --forms --title="$TITLE${NL}$place${NL}${NL}$symbol" \
            --text="$weather${PADDING}" --cancel-label="${LRM}$RESULTS_BTN_CANCEL" \
            --ok-label="${LRM}$RESULTS_BTN_OK"
    else
        zenity --text-info --title="$TITLE${NL}$place${NL}${NL}$symbol" \
            --height=800 --width=600 --font="$RESULTS_FONT" \
            --cancel-label="${LRM}$RESULTS_BTN_CANCEL" \
            --ok-label="${LRM}$RESULTS_BTN_OK" <<< "$weather${PADDING}" 
    fi

    exit_code=$?
    last_location="$location"
    echo "$last_location" > "$last_location_file"

    (( exit_code )) && break

done
